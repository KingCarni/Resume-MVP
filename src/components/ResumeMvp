"use client";

import Link from "next/link";
import React, { useMemo, useState } from "react";

type VerbStrength = {
  score: number;
  label: "Weak" | "OK" | "Strong";
  detectedVerb?: string;
  suggestion?: string;
  baseScore?: number;
  rewriteBonusApplied?: number;
};

type RewritePlanItem = {
  originalBullet?: any;
  suggestedKeywords?: any;
  rewrittenBullet?: any;

  needsMoreInfo?: boolean;
  notes?: string[];
  keywordHits?: string[];
  blockedKeywords?: string[];

  verbStrength?: VerbStrength; // BEFORE (from analyze)

  // ✅ server-provided mapping from bullet -> job section
  jobId?: string;
};

type ResumeTemplateId = "classic" | "modern" | "minimal";

type ResumeProfile = {
  fullName: string;
  titleLine: string;
  locationLine: string;
  email: string;
  phone: string;
  linkedin: string;
  portfolio: string;
  summary: string;
};

type ExperienceSection = {
  id: string;
  company: string;
  title: string;
  dates: string;
  location?: string;
};

type BulletAssignment = {
  sectionId: string;
};

type ExperienceJobFromApi = {
  id: string;
  company: string;
  title: string;
  dates: string;
  location?: string;
  bullets: string[];
  rawHeader?: string;
};

type AnalyzeResponse = {
  ok: boolean;
  error?: string;
  matchScore?: number;
  missingKeywords?: string[];
  bullets?: any[];
  rewritePlan?: RewritePlanItem[];
  debug?: any;

  metaBlocks?: {
    gamesShipped?: string[];
    metrics?: string[];
  };

  // ✅ server-parsed jobs
  experienceJobs?: ExperienceJobFromApi[];

  // ✅ optional mapping aligned to bullets/rewritePlan
  bulletJobIds?: string[];
};

async function parseApiResponse(res: Response) {
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return await res.json();
  return await res.text();
}

function isHtmlDoc(x: unknown) {
  return (
    typeof x === "string" &&
    (x.includes("<!DOCTYPE html>") || x.includes('id="__NEXT_DATA__"'))
  );
}

function bulletToText(b: any): string {
  if (typeof b === "string") return b;
  if (b && typeof b === "object") {
    const v = b.text ?? b.value ?? b.bullet ?? b.originalBullet ?? b.content;
    if (typeof v === "string") return v;
    return String(v ?? "");
  }
  return String(b ?? "");
}

function planItemToText(item: any): string {
  if (!item) return "";
  const raw = item.originalBullet ?? item.bullet ?? item.original ?? item.text ?? item;
  return bulletToText(raw).trim();
}

function keywordsToArray(k: any): string[] {
  if (Array.isArray(k)) return k.map((x) => String(x).trim()).filter(Boolean);
  if (typeof k === "string")
    return k
      .split(",")
      .map((s) => s.trim())
      .filter(Boolean);
  if (k && typeof k === "object" && Array.isArray(k.keywords)) {
    return k.keywords.map((x: any) => String(x).trim()).filter(Boolean);
  }
  return [];
}

function csvToArray(s: string): string[] {
  return (s || "")
    .split(",")
    .map((x) => x.trim())
    .filter(Boolean);
}

function normalizeForMatch(s: string) {
  return (s || "").toLowerCase().replace(/\s+/g, " ").trim();
}

function findInjectedTerms(text: string, terms: string[]) {
  const t = normalizeForMatch(text);
  const hits: string[] = [];
  for (const raw of terms) {
    const term = normalizeForMatch(raw);
    if (!term) continue;
    if (t.includes(term)) hits.push(raw);
  }
  return Array.from(new Set(hits));
}

function Chip({ text, muted }: { text: string; muted?: boolean }) {
  return (
    <span
      style={{
        display: "inline-flex",
        alignItems: "center",
        padding: "3px 10px",
        borderRadius: 999,
        border: "1px solid #ddd",
        background: muted ? "#fafafa" : "#f4f4f4",
        color: muted ? "#777" : "#222",
        fontSize: 12,
        fontWeight: 700,
      }}
    >
      {text}
    </span>
  );
}

function Callout({
  title,
  children,
  tone,
}: {
  title: string;
  children: React.ReactNode;
  tone: "warn" | "danger" | "info";
}) {
  const palette =
    tone === "warn"
      ? { bg: "#fff7e6", border: "#ffd38a", title: "#6a4b00" }
      : tone === "danger"
      ? { bg: "#ffe8e8", border: "#ffb3b3", title: "#7a1414" }
      : { bg: "#eef6ff", border: "#b9dcff", title: "#0b3b73" };

  return (
    <div
      style={{
        marginBottom: 10,
        background: palette.bg,
        border: `1px solid ${palette.border}`,
        padding: 10,
        borderRadius: 10,
      }}
    >
      <div style={{ fontWeight: 900, color: palette.title }}>{title}</div>
      <div style={{ marginTop: 4, opacity: 0.9 }}>{children}</div>
    </div>
  );
}

/** Client-side verb scoring (After display) */
function computeVerbStrength(bullet: string): VerbStrength {
  const raw = String(bullet ?? "").trim();
  const lower = raw.toLowerCase();

  const cleaned = lower
    .replace(/^[•\-\u2022\u00B7o\s]+/g, "")
    .replace(/[“”"]/g, '"')
    .trim();

  const words = cleaned.split(/\s+/).filter(Boolean);
  const opener = words.slice(0, 10).join(" ");

  const weakPhrases = [
    "worked with",
    "worked on",
    "helped",
    "assisted",
    "supported",
    "participated in",
    "involved in",
    "exposed to",
    "responsible for",
    "collaborated with",
    "was responsible for",
    "was involved in",
    "was tasked with",
    "was part of",
  ];

  const strongLeadVerbs = new Set([
    "led",
    "owned",
    "drove",
    "delivered",
    "shipped",
    "launched",
    "spearheaded",
    "directed",
    "managed",
    "mentored",
    "architected",
    "designed",
    "implemented",
    "automated",
    "optimized",
    "improved",
    "increased",
    "reduced",
    "cut",
    "saved",
    "prevented",
    "unblocked",
  ]);

  const solidVerbs = new Set([
    "tested",
    "validated",
    "executed",
    "created",
    "built",
    "documented",
    "triaged",
    "investigated",
    "debugged",
    "monitored",
    "coordinated",
    "refactored",
    "integrated",
    "migrated",
    "standardized",
    "streamlined",
  ]);

  const outcomeSignals =
    /\b(increased|reduced|improved|cut|saved|prevented|boosted|grew|decreased|accelerated|shortened)\b/i.test(
      raw
    );

  const metricSignals =
    /(%|\$\s?\d|\b\d+(\.\d+)?\s?(ms|s|sec|secs|minutes|min|hrs|hours|days|weeks)\b|\b\d+(\.\d+)?x\b|\b\d{2,}\b)/i.test(
      raw
    );

  const scopeSignals =
    /\b(api|pipeline|ci\/cd|release|deployment|automation|framework|test plan|test strategy|coverage|regression|observability|monitoring|dashboards|kpi|experiment|a\/b|tracking|instrumentation|backend|frontend|mobile|vr|ue4|ue5|unreal)\b/i.test(
      raw
    );

  const vagueSignals =
    /\b(various|several|some|things|stuff|etc|multiple tasks|as needed)\b/i.test(
      raw
    );

  const passiveSignals =
    /\b(was responsible for|was involved in|was tasked with|was assigned to|was part of)\b/i.test(
      opener
    );

  const filler = new Set([
    "successfully",
    "effectively",
    "proactively",
    "actively",
    "efficiently",
    "responsible",
    "for",
    "the",
    "a",
    "an",
    "to",
    "and",
    "with",
    "in",
    "on",
    "of",
  ]);

  let detectedVerb: string | undefined;
  for (const w of words.slice(0, 8)) {
    const word = w.replace(/[^\w-]/g, "");
    if (!word || filler.has(word)) continue;

    if (strongLeadVerbs.has(word) || solidVerbs.has(word)) {
      detectedVerb = word;
      break;
    }
    if (word.length >= 5 && word.endsWith("ed")) {
      detectedVerb = word;
      break;
    }
  }

  let baseScore = 62;
  const reasons: string[] = [];

  const matchedWeak = weakPhrases.find((p) => opener.startsWith(p));
  if (matchedWeak) {
    baseScore -= 10;
    reasons.push(`Weak opener (“${matchedWeak}”)`);
  }
  if (passiveSignals) {
    baseScore -= 8;
    reasons.push("Passive voice opener");
  }
  if (vagueSignals) {
    baseScore -= 6;
    reasons.push("Vague wording");
  }

  if (detectedVerb) {
    if (strongLeadVerbs.has(detectedVerb)) {
      baseScore += 22;
      reasons.push(`Strong verb (“${detectedVerb}”)`);
    } else if (solidVerbs.has(detectedVerb)) {
      baseScore += 10;
      reasons.push(`Solid verb (“${detectedVerb}”)`);
    } else {
      baseScore += 6;
      reasons.push(`Action verb (“${detectedVerb}”)`);
    }
  } else {
    baseScore -= 4;
    reasons.push("No clear action verb early");
  }

  if (scopeSignals) {
    baseScore += 10;
    reasons.push("Clear scope/system");
  }
  if (outcomeSignals) {
    baseScore += 12;
    reasons.push("Outcome language");
  }
  if (metricSignals) {
    baseScore += 12;
    reasons.push("Quantified impact");
  }

  baseScore = Math.max(0, Math.min(100, baseScore));

  const score = baseScore;
  const label: VerbStrength["label"] =
    score < 50 ? "Weak" : score < 80 ? "OK" : "Strong";

  let suggestion: string | undefined;
  if (label !== "Strong") {
    suggestion = reasons.length
      ? `Why: ${reasons.slice(0, 3).join(", ")}`
      : "Try a stronger opener and add outcome/metrics if truthful.";
  }

  return { score, label, detectedVerb, suggestion, baseScore };
}

function VerbStrengthBadge({
  vs,
  title,
}: {
  vs?: VerbStrength;
  title?: string;
}) {
  const label = vs?.label ?? "OK";
  const score =
    typeof vs?.score === "number" && Number.isFinite(vs.score) ? vs.score : 50;

  const styles =
    label === "Strong"
      ? { bg: "#e9f9ef", border: "#bfe9cd", text: "#0b4a24" }
      : label === "OK"
      ? { bg: "#eef6ff", border: "#b9dcff", text: "#0b3b73" }
      : { bg: "#fff3f3", border: "#ffcccc", text: "#7a1414" };

  return (
    <span
      title={
        title ||
        (vs?.suggestion
          ? `${label} (${score}) — ${vs.suggestion}`
          : `${label} (${score})`)
      }
      style={{
        display: "inline-flex",
        alignItems: "center",
        padding: "4px 10px",
        borderRadius: 999,
        border: `1px solid ${styles.border}`,
        background: styles.bg,
        color: styles.text,
        fontSize: 12,
        fontWeight: 900,
      }}
    >
      {label} ({score})
    </span>
  );
}

function VerbStrengthDelta({
  before,
  after,
}: {
  before?: VerbStrength;
  after?: VerbStrength;
}) {
  if (!before || !after) return null;

  const delta = after.score - before.score;
  const sign = delta > 0 ? "+" : delta < 0 ? "−" : "";
  const abs = Math.abs(delta);

  const isUp = delta > 0;
  const isDown = delta < 0;

  const bg = isUp ? "#e9f9ef" : isDown ? "#fff3f3" : "#f4f4f4";
  const border = isUp ? "#bfe9cd" : isDown ? "#ffcccc" : "#ddd";
  const color = isUp ? "#0b4a24" : isDown ? "#7a1414" : "#222";

  return (
    <span
      title="Verb Strength change from original → rewrite"
      style={{
        display: "inline-flex",
        alignItems: "center",
        padding: "4px 10px",
        borderRadius: 999,
        border: `1px solid ${border}`,
        background: bg,
        color,
        fontSize: 12,
        fontWeight: 900,
      }}
    >
      Δ {sign}
      {abs}
    </span>
  );
}

/** ---------- Resume Template HTML ---------- **/

function escapeHtml(s: string) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

function templateStyles(template: ResumeTemplateId) {
  if (template === "modern") {
    return `
      :root { --ink:#111; --muted:#555; --line:#e7e7e7; --accent:#0b57d0; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ink); margin:0; background:#f6f7fb; }
      .page { max-width: 860px; margin: 22px auto; background:white; border:1px solid var(--line); border-radius: 16px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
      .top { display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 18px; padding: 26px 26px 18px; background: linear-gradient(180deg, rgba(11,87,208,.08), rgba(255,255,255,0)); border-bottom:1px solid var(--line); }
      .name { font-size: 30px; font-weight: 900; letter-spacing: -.02em; margin:0; }
      .title { margin-top:6px; font-size: 14px; color:var(--muted); font-weight:700; }
      .contact { font-size: 12px; color:var(--muted); display:grid; gap: 6px; justify-items:end; }
      .chip { display:inline-block; border:1px solid var(--line); padding:6px 10px; border-radius: 999px; background:white; }
      .content { padding: 18px 26px 26px; }
      .section { margin-top: 16px; }
      .h { display:flex; align-items:center; gap:10px; margin:0 0 8px; font-size: 13px; font-weight: 900; letter-spacing: .08em; text-transform:uppercase; }
      .bar { height: 10px; width: 10px; border-radius: 3px; background: var(--accent); }
      .summary { color:var(--muted); line-height: 1.45; font-size: 13px; }
      .job { margin-top: 12px; border:1px solid var(--line); border-radius: 12px; padding: 12px; }
      .jobhead { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      .jobtitle { font-weight: 900; }
      .jobmeta { color: var(--muted); font-size: 12px; font-weight:700; }
      ul { margin: 8px 0 0 18px; padding:0; }
      li { margin: 6px 0; line-height: 1.35; }
      .meta { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
      .box { border:1px solid var(--line); border-radius: 12px; padding: 12px; background:#fff; }
      .boxtitle { font-weight: 900; font-size: 12px; color: var(--ink); margin:0 0 6px; }
      .small { font-size: 12px; color: var(--muted); }
      @media print { body{background:white;} .page{box-shadow:none; margin:0; border:none; border-radius:0;} }
    `;
  }

  if (template === "minimal") {
    return `
      :root { --ink:#111; --muted:#444; --line:#e7e7e7; }
      body { font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; color:var(--ink); margin:0; background:#fff; }
      .page { max-width: 820px; margin: 26px auto; padding: 0 22px 22px; }
      .top { padding: 16px 0 10px; border-bottom: 1px solid var(--line); }
      .name { font-size: 30px; font-weight: 800; margin:0; }
      .title { margin-top:6px; font-size: 14px; color:var(--muted); }
      .contact { margin-top:10px; font-size: 12px; color:var(--muted); display:flex; flex-wrap:wrap; gap:10px; }
      .content { padding-top: 10px; }
      .h { margin: 14px 0 6px; font-size: 12px; font-weight: 900; letter-spacing: .12em; text-transform:uppercase; }
      .summary { color:var(--muted); line-height: 1.45; font-size: 13px; }
      .job { margin-top: 10px; padding-top: 10px; border-top:1px solid var(--line); }
      .jobhead { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
      .jobtitle { font-weight: 900; }
      .jobmeta { color: var(--muted); font-size: 12px; font-weight:700; }
      ul { margin: 8px 0 0 18px; padding:0; }
      li { margin: 6px 0; line-height: 1.35; }
      .meta { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
      .box { border-top:1px solid var(--line); padding-top:10px; }
      .boxtitle { font-weight: 900; font-size: 12px; margin:0 0 6px; }
      .small { font-size: 12px; color: var(--muted); }
      @media print { .page{margin:0; padding:0 10px 10px;} }
    `;
  }

  return `
    :root { --ink:#111; --muted:#444; --line:#e7e7e7; --accent:#1f2937; }
    body { font-family: Calibri, Arial, Helvetica, sans-serif; color:var(--ink); margin:0; background:#fff; }
    .page { max-width: 850px; margin: 18px auto; border: 1px solid var(--line); padding: 18px 22px; }
    .top { display:flex; justify-content:space-between; gap: 12px; border-bottom:1px solid var(--line); padding-bottom: 10px; }
    .name { font-size: 28px; font-weight: 900; margin:0; }
    .title { margin-top:6px; font-size: 13px; color:var(--muted); font-weight:700; }
    .contact { font-size: 12px; color:var(--muted); text-align:right; display:grid; gap:4px; }
    .h { margin: 14px 0 6px; font-size: 13px; font-weight: 900; color: var(--accent); }
    .summary { color:var(--muted); line-height: 1.45; font-size: 13px; }
    .job { margin-top: 10px; border-top:1px solid var(--line); padding-top: 10px; }
    .jobhead { display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .jobtitle { font-weight: 900; }
    .jobmeta { color: var(--muted); font-size: 12px; font-weight:700; }
    ul { margin: 6px 0 0 18px; padding:0; }
    li { margin: 6px 0; line-height: 1.35; }
    .meta { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .box { border:1px solid var(--line); padding: 10px; }
    .boxtitle { font-weight: 900; font-size: 12px; margin:0 0 6px; }
    .small { font-size: 12px; color: var(--muted); }
    @media print { .page{border:none; margin:0; padding:0 8px 8px;} }
  `;
}

function buildResumeHtml(args: {
  template: ResumeTemplateId;
  profile: ResumeProfile;
  sections: ExperienceSection[];
  bulletsBySection: Record<string, string[]>;
  metaGames: string[];
  metaMetrics: string[];
  includeMeta: boolean;
}) {
  const { template, profile, sections, bulletsBySection, metaGames, metaMetrics, includeMeta } =
    args;

  const safe = (s: string) => escapeHtml(s || "");

  const contactBits = [
    profile.locationLine?.trim() ? safe(profile.locationLine) : "",
    profile.email?.trim() ? safe(profile.email) : "",
    profile.phone?.trim() ? safe(profile.phone) : "",
    profile.linkedin?.trim() ? safe(profile.linkedin) : "",
    profile.portfolio?.trim() ? safe(profile.portfolio) : "",
  ].filter(Boolean);

  const metaHtml =
    includeMeta && (metaGames.length || metaMetrics.length)
      ? `
    <div class="section">
      <div class="h">${template === "modern" ? `<span class="bar"></span>` : ""}Highlights</div>
      <div class="meta">
        ${
          metaGames.length
            ? `<div class="box">
                <div class="boxtitle">Games Shipped</div>
                <div class="small">${metaGames
                  .slice(0, 14)
                  .map((x) => `• ${safe(String(x))}`)
                  .join("<br/>")}</div>
              </div>`
            : `<div></div>`
        }
        ${
          metaMetrics.length
            ? `<div class="box">
                <div class="boxtitle">Key Metrics</div>
                <div class="small">${metaMetrics
                  .slice(0, 14)
                  .map((x) => `• ${safe(String(x))}`)
                  .join("<br/>")}</div>
              </div>`
            : `<div></div>`
        }
      </div>
    </div>`
      : "";

  const jobsHtml = sections
    .map((sec) => {
      const list = bulletsBySection[sec.id] || [];
      if (!list.length) return "";

      const headerLeft = `${safe(sec.company || "Company")} — ${safe(sec.title || "Role")}`;

      const headerRight = [sec.location?.trim() ? safe(sec.location) : "", safe(sec.dates || "")]
        .filter(Boolean)
        .join(" • ");

      return `
        <div class="job">
          <div class="jobhead">
            <div class="jobtitle">${headerLeft}</div>
            <div class="jobmeta">${headerRight}</div>
          </div>
          <ul>
            ${list.map((b) => `<li>${safe(b)}</li>`).join("")}
          </ul>
        </div>
      `;
    })
    .filter(Boolean)
    .join("");

  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resume - ${safe(profile.fullName || "Updated")}</title>
  <style>
    ${templateStyles(template)}
  </style>
</head>
<body>
  <div class="page">
    <div class="top">
      <div>
        <h1 class="name">${safe(profile.fullName || "Your Name")}</h1>
        <div class="title">${safe(profile.titleLine || "QA Lead / QA Manager")}</div>
        ${
          template === "modern"
            ? `<div style="margin-top:10px; color:var(--muted); font-size:12px;">
                ${safe(profile.summary || "")}
              </div>`
            : ""
        }
      </div>
      <div class="contact">
        ${
          template === "modern"
            ? contactBits.map((c) => `<div class="chip">${c}</div>`).join("")
            : contactBits.map((c) => `<div>${c}</div>`).join("")
        }
      </div>
    </div>

    <div class="content">
      ${
        template !== "modern"
          ? `<div class="section">
              <div class="h">Summary</div>
              <div class="summary">${safe(profile.summary || "")}</div>
            </div>`
          : ""
      }

      ${metaHtml}

      <div class="section">
        <div class="h">${template === "modern" ? `<span class="bar"></span>` : ""}Experience</div>
        ${jobsHtml || `<div class="summary">No experience sections yet.</div>`}
      </div>
    </div>
  </div>
</body>
</html>`;
}

function downloadHtml(filename: string, html: string) {
  const blob = new Blob([html], { type: "text/html;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename.endsWith(".html") ? filename : `${filename}.html`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function openPrintWindow(html: string) {
  const w = window.open("", "_blank", "noopener,noreferrer");
  if (!w) return;
  w.document.open();
  w.document.write(html);
  w.document.close();
  setTimeout(() => w.print(), 250);
}

function uid(prefix = "sec") {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now()}`;
}

export default function ResumeMvp() {
  const [resumeText, setResumeText] = useState("");
  const [jobText, setJobText] = useState("");
  const [file, setFile] = useState<File | null>(null);

  const [onlyExperienceBullets, setOnlyExperienceBullets] = useState(true);

  const [sourceCompany, setSourceCompany] = useState("Prodigy Education");
  const [targetCompany, setTargetCompany] = useState("");
  const [targetProductsCsv, setTargetProductsCsv] = useState("");
  const [blockedTermsCsv, setBlockedTermsCsv] = useState("");

  const [analysis, setAnalysis] = useState<AnalyzeResponse | null>(null);
  const [loadingAnalyze, setLoadingAnalyze] = useState(false);
  const [loadingRewriteIndex, setLoadingRewriteIndex] = useState<number | null>(null);

  const [error, setError] = useState<string | null>(null);
  const [showDebugJson, setShowDebugJson] = useState(false);
  const [logNetworkDebug, setLogNetworkDebug] = useState(true);

  // Resume generator UI
  const [selectedBulletIdx, setSelectedBulletIdx] = useState<Set<number>>(() => new Set());
  const [loadingBatchRewrite, setLoadingBatchRewrite] = useState(false);
  const [includeMetaInResumeDoc, setIncludeMetaInResumeDoc] = useState(true);

  // Template + profile
  const [resumeTemplate, setResumeTemplate] = useState<ResumeTemplateId>("modern");
  const [profile, setProfile] = useState<ResumeProfile>({
    fullName: "Harley Curtis",
    titleLine: "QA Lead / QA Manager",
    locationLine: "Vancouver, BC",
    email: "harleydean17@gmail.com",
    phone: "",
    linkedin: "linkedin.com/in/harley-curtis",
    portfolio: "",
    summary:
      "QA leader with experience shipping games and driving quality outcomes across releases, automation, and cross-functional execution.",
  });

  // ✅ Experience sections + bullet assignments
  const [sections, setSections] = useState<ExperienceSection[]>([
    { id: "default", company: "Experience", title: "", dates: "", location: "" },
  ]);
  const [assignments, setAssignments] = useState<Record<number, BulletAssignment>>({});

  const canAnalyze = useMemo(() => {
    const hasResume = !!file || resumeText.trim().length > 0;
    const hasJob = jobText.trim().length > 0;
    return hasResume && hasJob;
  }, [file, resumeText, jobText]);

  function clearFile() {
    setFile(null);
  }

  function toggleSelected(i: number) {
    setSelectedBulletIdx((prev) => {
      const next = new Set(prev);
      if (next.has(i)) next.delete(i);
      else next.add(i);
      return next;
    });
  }

  function selectAll(count: number) {
    setSelectedBulletIdx(new Set(Array.from({ length: count }, (_, i) => i)));
  }

  function selectNone() {
    setSelectedBulletIdx(new Set());
  }

  function ensureAssignmentsForPlan(planLen: number, fallbackSectionId: string) {
    setAssignments((prev) => {
      const next = { ...prev };
      for (let i = 0; i < planLen; i++) {
        if (!next[i]) next[i] = { sectionId: fallbackSectionId };
      }
      return next;
    });
  }

  function setBulletSection(i: number, sectionId: string) {
    setAssignments((prev) => ({ ...prev, [i]: { sectionId } }));
  }

  function addSection() {
    const id = uid();
    setSections((prev) => [
      ...prev,
      { id, company: "Company", title: "Role", dates: "Dates", location: "" },
    ]);
  }

  function deleteSection(sectionId: string) {
    setSections((prev) => {
      if (prev.length <= 1) return prev;
      return prev.filter((s) => s.id !== sectionId);
    });

    setAssignments((prev) => {
      const next = { ...prev };
      const fallbackId = sections.find((s) => s.id !== sectionId)?.id || sections[0]?.id || "default";
      for (const k of Object.keys(next)) {
        const idx = Number(k);
        if (next[idx]?.sectionId === sectionId) next[idx] = { sectionId: fallbackId };
      }
      return next;
    });
  }

  function moveSection(sectionId: string, dir: -1 | 1) {
    setSections((prev) => {
      const i = prev.findIndex((s) => s.id === sectionId);
      if (i < 0) return prev;
      const j = i + dir;
      if (j < 0 || j >= prev.length) return prev;
      const next = [...prev];
      const tmp = next[i];
      next[i] = next[j];
      next[j] = tmp;
      return next;
    });
  }

  function updateSection(sectionId: string, patch: Partial<ExperienceSection>) {
    setSections((prev) => prev.map((s) => (s.id === sectionId ? { ...s, ...patch } : s)));
  }

  /**
   * ✅ Build assignments using server mapping.
   * Priority:
   * 1) rewritePlan[i].jobId
   * 2) bulletJobIds[i]
   * 3) fallback to first section
   */
  function buildAssignmentsFromServerMapping(args: {
    rewritePlan: RewritePlanItem[];
    bulletJobIds?: string[];
    knownSectionIds: Set<string>;
    fallbackSectionId: string;
  }) {
    const { rewritePlan, bulletJobIds, knownSectionIds, fallbackSectionId } = args;

    const next: Record<number, BulletAssignment> = {};

    for (let i = 0; i < rewritePlan.length; i++) {
      const jobIdFromPlan = String(rewritePlan[i]?.jobId ?? "").trim();
      const jobIdFromArray = String(bulletJobIds?.[i] ?? "").trim();
      const candidate = jobIdFromPlan || jobIdFromArray;

      next[i] = {
        sectionId: candidate && knownSectionIds.has(candidate) ? candidate : fallbackSectionId,
      };
    }

    return next;
  }

  async function handleAnalyze() {
    setLoadingAnalyze(true);
    setError(null);
    setAnalysis(null);
    setSelectedBulletIdx(new Set());
    setAssignments({});

    try {
      let res: Response;

      if (file) {
        const fd = new FormData();
        fd.append("file", file);
        fd.append("jobText", jobText);
        if (resumeText.trim()) fd.append("resumeText", resumeText.trim());
        fd.append("onlyExperienceBullets", String(onlyExperienceBullets));
        res = await fetch("/api/analyze", { method: "POST", body: fd });
      } else {
        res = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ resumeText, jobText, onlyExperienceBullets }),
        });
      }

      const payload = await parseApiResponse(res);

      if (logNetworkDebug) {
        console.log("[analyze] status:", res.status);
        console.log("[analyze] onlyExperienceBullets:", onlyExperienceBullets);
        console.log("[analyze] payload:", payload);
      }

      if (isHtmlDoc(payload)) {
        throw new Error(
          `Analyze returned HTML (server error). Check terminal logs.\nStatus: ${res.status}`
        );
      }

      if (!res.ok) {
        throw new Error(typeof payload === "string" ? payload : payload?.error || "Analyze failed");
      }

      if (typeof payload === "string") {
        throw new Error("Analyze returned unexpected non-JSON response.");
      }

      setAnalysis(payload);

      const rewritePlan = Array.isArray(payload?.rewritePlan)
        ? (payload.rewritePlan as RewritePlanItem[])
        : [];
      const planLen = rewritePlan.length;

      const jobs = Array.isArray(payload?.experienceJobs)
        ? (payload.experienceJobs as ExperienceJobFromApi[])
        : [];

      const nextSections: ExperienceSection[] =
        jobs.length > 0
          ? jobs.map((j) => ({
              id: String(j.id),
              company: String(j.company || "Company"),
              title: String(j.title || "Role"),
              dates: String(j.dates || "Dates"),
              location: j.location ? String(j.location) : "",
            }))
          : [{ id: "default", company: "Experience", title: "", dates: "", location: "" }];

      setSections(nextSections);

      const knownSectionIds = new Set(nextSections.map((s) => s.id));
      const fallbackId = nextSections[0]?.id || "default";

      if (planLen) {
        const bulletJobIds = Array.isArray(payload?.bulletJobIds)
          ? (payload.bulletJobIds as string[])
          : undefined;

        const auto = buildAssignmentsFromServerMapping({
          rewritePlan,
          bulletJobIds,
          knownSectionIds,
          fallbackSectionId: fallbackId,
        });

        setAssignments(auto);
        ensureAssignmentsForPlan(planLen, fallbackId);
      } else {
        setAssignments({});
      }
    } catch (e: any) {
      setError(e?.message || "Analyze failed");
    } finally {
      setLoadingAnalyze(false);
    }
  }

  async function postRewriteWithFallback(body: any) {
    const endpoints = ["/api/rewriteBullet", "/api/rewrite-bullet"];

    let lastRes: Response | null = null;
    let lastPayload: any = null;

    for (const url of endpoints) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const payload = await parseApiResponse(res);

      if (logNetworkDebug) {
        console.log(`[rewrite] tried ${url} -> status:`, res.status);
        console.log(`[rewrite] payload from ${url}:`, payload);
      }

      if (res.status !== 404) return { res, payload, url };

      lastRes = res;
      lastPayload = payload;
    }

    return {
      res: lastRes!,
      payload: lastPayload,
      url: endpoints[endpoints.length - 1],
    };
  }

  async function handleRewriteBullet(index: number) {
    if (!analysis) return;

    const bullets = Array.isArray(analysis.bullets) ? analysis.bullets : [];
    const rewritePlan = Array.isArray(analysis.rewritePlan) ? analysis.rewritePlan : [];

    const planItem = rewritePlan[index];

    const originalBullet = planItemToText(planItem) || bulletToText(bullets[index]).trim();
    const suggestedKeywords = keywordsToArray(planItem?.suggestedKeywords);

    if (!originalBullet) {
      setError("Missing original bullet for rewrite. Re-run Analyze or confirm bullets are being extracted.");
      return;
    }

    setLoadingRewriteIndex(index);
    setError(null);

    try {
      const targetProducts = csvToArray(targetProductsCsv);
      const blockedTerms = csvToArray(blockedTermsCsv);

      const requestBody = {
        originalBullet,
        suggestedKeywords,
        jobText,

        sourceCompany: sourceCompany.trim(),
        targetCompany: targetCompany.trim(),
        targetProducts,
        blockedTerms,

        role: "QA Lead",
        tone: "confident, concise, impact-driven",
      };

      const { res, payload } = await postRewriteWithFallback(requestBody);

      if (isHtmlDoc(payload)) {
        throw new Error(
          `Rewrite returned HTML (server error). Check terminal logs.\nStatus: ${res.status}`
        );
      }

      if (!res.ok) {
        throw new Error(typeof payload === "string" ? payload : payload?.error || "Rewrite failed");
      }

      if (typeof payload === "string") {
        throw new Error("Rewrite returned unexpected non-JSON response.");
      }

      const rewrittenBullet = String(payload?.rewrittenBullet ?? "").trim();
      const needsMoreInfo = !!payload?.needsMoreInfo;
      const notes = Array.isArray(payload?.notes) ? payload.notes : [];
      const keywordHits = Array.isArray(payload?.keywordHits) ? payload.keywordHits : [];
      const blockedKeywords = Array.isArray(payload?.blockedKeywords) ? payload.blockedKeywords : [];

      if (!rewrittenBullet) throw new Error("AI returned empty rewrite");

      setAnalysis((prev) => {
        if (!prev) return prev;

        const prevBullets = Array.isArray(prev.bullets) ? prev.bullets : [];
        const prevPlan = Array.isArray(prev.rewritePlan) ? prev.rewritePlan : [];

        const nextPlan =
          prevPlan.length > 0
            ? [...prevPlan]
            : prevBullets.slice(0, 20).map((b) => ({
                originalBullet: bulletToText(b),
                suggestedKeywords: [],
                rewrittenBullet: "",
                needsMoreInfo: false,
                notes: [],
                keywordHits: [],
                blockedKeywords: [],
                verbStrength: undefined,
                jobId: undefined,
              }));

        if (!nextPlan[index]) {
          nextPlan[index] = {
            originalBullet,
            suggestedKeywords,
            rewrittenBullet: "",
            needsMoreInfo: false,
            notes: [],
            keywordHits: [],
            blockedKeywords: [],
            verbStrength: undefined,
            jobId: undefined,
          };
        }

        nextPlan[index] = {
          ...nextPlan[index],
          rewrittenBullet,
          needsMoreInfo,
          notes,
          keywordHits,
          blockedKeywords,
        };

        return { ...prev, rewritePlan: nextPlan };
      });
    } catch (e: any) {
      setError(e?.message || "Rewrite failed");
    } finally {
      setLoadingRewriteIndex(null);
    }
  }

  async function handleRewriteSelected() {
    if (!analysis) return;

    const plan = Array.isArray(analysis.rewritePlan) ? analysis.rewritePlan : [];
    if (!plan.length) {
      setError("No rewrite plan available. Run Analyze first.");
      return;
    }

    const selected = Array.from(selectedBulletIdx).sort((a, b) => a - b);
    if (!selected.length) {
      setError("Select at least one bullet to rewrite.");
      return;
    }

    setLoadingBatchRewrite(true);
    setError(null);

    try {
      for (const i of selected) {
        // sequential on purpose (keeps rate limits happy)
        // eslint-disable-next-line no-await-in-loop
        await handleRewriteBullet(i);
      }
    } finally {
      setLoadingBatchRewrite(false);
    }
  }

  const rewritePlan = Array.isArray(analysis?.rewritePlan) ? analysis!.rewritePlan! : [];

  const metaGames = Array.isArray(analysis?.metaBlocks?.gamesShipped)
    ? analysis!.metaBlocks!.gamesShipped!
    : [];
  const metaMetrics = Array.isArray(analysis?.metaBlocks?.metrics)
    ? analysis!.metaBlocks!.metrics!
    : [];

  const guardrailTerms = useMemo(() => {
    const terms: string[] = [];
    if (targetCompany.trim()) terms.push(targetCompany.trim());
    terms.push(...csvToArray(targetProductsCsv));
    terms.push(...csvToArray(blockedTermsCsv));
    return terms.filter(Boolean);
  }, [targetCompany, targetProductsCsv, blockedTermsCsv]);

  const selectedCount = selectedBulletIdx.size;

  const appliedBulletText = useMemo(() => {
    if (!rewritePlan.length) return [];
    return rewritePlan.map((item, i) => {
      const original = planItemToText(item);
      const rewritten = String(item?.rewrittenBullet ?? "").trim();
      const isSelected = selectedBulletIdx.has(i);
      if (isSelected && rewritten) return rewritten;
      return original;
    });
  }, [rewritePlan, selectedBulletIdx]);

  const bulletsBySection = useMemo(() => {
    const map: Record<string, string[]> = {};
    for (const s of sections) map[s.id] = [];
    if (!rewritePlan.length) return map;

    for (let i = 0; i < rewritePlan.length; i++) {
      const secId = assignments[i]?.sectionId || sections[0]?.id || "default";
      if (!map[secId]) map[secId] = [];
      map[secId].push(appliedBulletText[i]);
    }
    return map;
  }, [sections, assignments, rewritePlan.length, appliedBulletText]);

  const resumeHtml = useMemo(() => {
    if (!analysis || !rewritePlan.length) return "";
    return buildResumeHtml({
      template: resumeTemplate,
      profile,
      sections,
      bulletsBySection,
      metaGames,
      metaMetrics,
      includeMeta: includeMetaInResumeDoc,
    });
  }, [
    analysis,
    rewritePlan.length,
    resumeTemplate,
    profile,
    sections,
    bulletsBySection,
    metaGames,
    metaMetrics,
    includeMetaInResumeDoc,
  ]);

  function handleDownloadHtml() {
    if (!resumeHtml) return;
    downloadHtml("resume-template.html", resumeHtml);
  }

  function handlePrintPdf() {
    if (!resumeHtml) return;
    openPrintWindow(resumeHtml);
  }

  return (
    <main style={{ maxWidth: 1100, margin: "0 auto", padding: 24 }}>
      {/* Simple nav (works once /resume + /cover-letter pages exist) */}
      <div style={{ display: "flex", gap: 10, flexWrap: "wrap", marginBottom: 14 }}>
        <Link
          href="/resume"
          style={{
            padding: "8px 12px",
            border: "1px solid #ddd",
            borderRadius: 10,
            textDecoration: "none",
            fontWeight: 900,
            color: "inherit",
          }}
        >
          Resume Compiler
        </Link>
        <Link
          href="/cover-letter"
          style={{
            padding: "8px 12px",
            border: "1px solid #ddd",
            borderRadius: 10,
            textDecoration: "none",
            fontWeight: 900,
            color: "inherit",
          }}
        >
          Cover Letter Generator
        </Link>
      </div>

      <h1 style={{ margin: 0, fontSize: 28, fontWeight: 800 }}>Resume MVP</h1>
      <p style={{ marginTop: 8, opacity: 0.8 }}>
        Analyze → auto-detect jobs → auto-assign bullets → rewrite selected → generate a clean template.
      </p>

      <section
        style={{
          marginTop: 16,
          border: "1px solid #ddd",
          borderRadius: 12,
          padding: 16,
          display: "grid",
          gap: 14,
        }}
      >
        <div>
          <div style={{ fontWeight: 700, marginBottom: 6 }}>Resume upload (PDF/DOCX)</div>

          <div style={{ display: "flex", gap: 12, alignItems: "center" }}>
            <input type="file" accept=".pdf,.docx" onChange={(e) => setFile(e.target.files?.[0] ?? null)} />
            {file && (
              <button type="button" onClick={clearFile}>
                Clear file
              </button>
            )}
          </div>

          {file && (
            <div style={{ marginTop: 8, opacity: 0.85 }}>
              Selected: <strong>{file.name}</strong>
            </div>
          )}
        </div>

        <div>
          <div style={{ fontWeight: 700, marginBottom: 6 }}>Or paste resume text (optional if uploading)</div>
          <textarea
            value={resumeText}
            onChange={(e) => setResumeText(e.target.value)}
            rows={8}
            placeholder="Paste resume text…"
            style={{ width: "100%", padding: 10 }}
          />
        </div>

        <div>
          <div style={{ fontWeight: 700, marginBottom: 6 }}>Job posting text (required)</div>
          <textarea
            value={jobText}
            onChange={(e) => setJobText(e.target.value)}
            rows={8}
            placeholder="Paste job posting…"
            style={{ width: "100%", padding: 10 }}
          />
        </div>

        <div
          style={{
            borderTop: "1px solid #eee",
            paddingTop: 12,
            display: "grid",
            gap: 10,
          }}
        >
          <div style={{ fontWeight: 800 }}>Target guardrails</div>

          <div style={{ display: "grid", gap: 6 }}>
            <label style={{ fontWeight: 700 }}>Source company (optional)</label>
            <input
              value={sourceCompany}
              onChange={(e) => setSourceCompany(e.target.value)}
              placeholder="e.g., Prodigy Education"
              style={{ width: "100%", padding: 10 }}
            />
          </div>

          <div style={{ display: "grid", gap: 6 }}>
            <label style={{ fontWeight: 700 }}>Target company (recommended)</label>
            <input
              value={targetCompany}
              onChange={(e) => setTargetCompany(e.target.value)}
              placeholder="e.g., Scopely"
              style={{ width: "100%", padding: 10 }}
            />
          </div>

          <div style={{ display: "grid", gap: 6 }}>
            <label style={{ fontWeight: 700 }}>Target products (comma-separated, optional)</label>
            <input
              value={targetProductsCsv}
              onChange={(e) => setTargetProductsCsv(e.target.value)}
              placeholder="e.g., Monopoly Go, Yahtzee"
              style={{ width: "100%", padding: 10 }}
            />
          </div>

          <div style={{ display: "grid", gap: 6 }}>
            <label style={{ fontWeight: 700 }}>Extra blocked terms (comma-separated, optional)</label>
            <input
              value={blockedTermsCsv}
              onChange={(e) => setBlockedTermsCsv(e.target.value)}
              placeholder="e.g., Monopoly, Scopely, live ops"
              style={{ width: "100%", padding: 10 }}
            />
          </div>
        </div>

        <div style={{ display: "flex", gap: 12, alignItems: "center", flexWrap: "wrap" }}>
          <button
            type="button"
            onClick={handleAnalyze}
            disabled={!canAnalyze || loadingAnalyze}
            style={{
              padding: "10px 14px",
              fontWeight: 800,
              cursor: !canAnalyze || loadingAnalyze ? "not-allowed" : "pointer",
            }}
          >
            {loadingAnalyze ? "Analyzing…" : "Analyze"}
          </button>

          <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <input
              type="checkbox"
              checked={onlyExperienceBullets}
              onChange={(e) => setOnlyExperienceBullets(e.target.checked)}
            />
            Only rewrite experience bullets
          </label>

          <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <input type="checkbox" checked={showDebugJson} onChange={(e) => setShowDebugJson(e.target.checked)} />
            Show debug JSON
          </label>

          <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
            <input type="checkbox" checked={logNetworkDebug} onChange={(e) => setLogNetworkDebug(e.target.checked)} />
            Log network debug
          </label>
        </div>

        {error && (
          <div
            style={{
              background: "#ffe8e8",
              border: "1px solid #ffb3b3",
              padding: 12,
              borderRadius: 10,
            }}
          >
            <strong>Error:</strong> {error}
          </div>
        )}
      </section>

      {analysis && (
        <section
          style={{
            marginTop: 18,
            border: "1px solid #ddd",
            borderRadius: 12,
            padding: 16,
          }}
        >
          <h2 style={{ marginTop: 0 }}>Resume Generator</h2>

          <div style={{ display: "grid", gap: 8, marginBottom: 10 }}>
            <div>
              <strong>Match Score:</strong> {analysis.matchScore ?? "(not provided)"}
            </div>
            <div>
              <strong>Missing Keywords:</strong>{" "}
              {(analysis.missingKeywords ?? []).length ? analysis.missingKeywords?.join(", ") : "(none or not provided)"}
            </div>
          </div>

          {/* Experience Sections Editor */}
          <div
            style={{
              marginTop: 10,
              border: "1px solid #eee",
              borderRadius: 12,
              padding: 12,
            }}
          >
            <div style={{ fontWeight: 900, marginBottom: 8 }}>Experience Sections (auto-detected)</div>

            <div style={{ display: "flex", gap: 10, flexWrap: "wrap" }}>
              <button type="button" onClick={addSection} style={{ padding: "8px 12px", fontWeight: 900 }}>
                + Add job (manual override)
              </button>

              <div style={{ opacity: 0.8 }}>
                Jobs and bullet assignments are filled automatically from Analyze. You can edit anything.
              </div>
            </div>

            <div style={{ marginTop: 10, display: "grid", gap: 10 }}>
              {sections.map((s, idx) => (
                <div
                  key={s.id}
                  style={{
                    border: "1px solid #e7e7e7",
                    borderRadius: 12,
                    padding: 10,
                    display: "grid",
                    gap: 8,
                  }}
                >
                  <div
                    style={{
                      display: "flex",
                      justifyContent: "space-between",
                      gap: 10,
                      flexWrap: "wrap",
                      alignItems: "center",
                    }}
                  >
                    <div style={{ fontWeight: 900 }}>Job {idx + 1}</div>
                    <div style={{ display: "flex", gap: 8 }}>
                      <button type="button" onClick={() => moveSection(s.id, -1)} disabled={idx === 0}>
                        ↑
                      </button>
                      <button
                        type="button"
                        onClick={() => moveSection(s.id, 1)}
                        disabled={idx === sections.length - 1}
                      >
                        ↓
                      </button>
                      <button
                        type="button"
                        onClick={() => deleteSection(s.id)}
                        disabled={sections.length <= 1}
                        title={sections.length <= 1 ? "Need at least one section" : "Delete this job section"}
                      >
                        Delete
                      </button>
                    </div>
                  </div>

                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <input
                      value={s.company}
                      onChange={(e) => updateSection(s.id, { company: e.target.value })}
                      placeholder="Company"
                      style={{ padding: 10 }}
                    />
                    <input
                      value={s.title}
                      onChange={(e) => updateSection(s.id, { title: e.target.value })}
                      placeholder="Title"
                      style={{ padding: 10 }}
                    />
                  </div>

                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <input
                      value={s.dates}
                      onChange={(e) => updateSection(s.id, { dates: e.target.value })}
                      placeholder="Dates (e.g., Jan 2021 – Present)"
                      style={{ padding: 10 }}
                    />
                    <input
                      value={s.location ?? ""}
                      onChange={(e) => updateSection(s.id, { location: e.target.value })}
                      placeholder="Location (optional)"
                      style={{ padding: 10 }}
                    />
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Template + Export */}
          <section
            style={{
              marginTop: 14,
              borderTop: "1px solid #eee",
              paddingTop: 14,
              display: "grid",
              gap: 12,
            }}
          >
            <h3 style={{ margin: "6px 0" }}>Templates + Export</h3>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
              <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12 }}>
                <div style={{ fontWeight: 900, marginBottom: 8 }}>Template + Export</div>

                <label style={{ display: "grid", gap: 6, marginBottom: 10 }}>
                  <span style={{ fontWeight: 700 }}>Template</span>
                  <select
                    value={resumeTemplate}
                    onChange={(e) => setResumeTemplate(e.target.value as ResumeTemplateId)}
                    style={{ padding: "10px" }}
                  >
                    <option value="modern">Modern</option>
                    <option value="classic">Classic</option>
                    <option value="minimal">Minimal</option>
                  </select>
                </label>

                <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
                  <input
                    type="checkbox"
                    checked={includeMetaInResumeDoc}
                    onChange={(e) => setIncludeMetaInResumeDoc(e.target.checked)}
                  />
                  Include “Highlights” (Games Shipped + Metrics)
                </label>

                <div style={{ marginTop: 10, display: "flex", gap: 10, flexWrap: "wrap" }}>
                  <button
                    type="button"
                    onClick={handlePrintPdf}
                    disabled={!resumeHtml}
                    style={{ padding: "8px 12px", fontWeight: 900 }}
                    title="Opens a print window: choose Save as PDF"
                  >
                    Generate (Print / Save as PDF)
                  </button>

                  <button
                    type="button"
                    onClick={handleDownloadHtml}
                    disabled={!resumeHtml}
                    style={{ padding: "8px 12px", fontWeight: 900 }}
                  >
                    Download HTML
                  </button>
                </div>
              </div>

              <div style={{ border: "1px solid #eee", borderRadius: 12, padding: 12 }}>
                <div style={{ fontWeight: 900, marginBottom: 8 }}>Profile Fields</div>

                <div style={{ display: "grid", gap: 8 }}>
                  <input
                    value={profile.fullName}
                    onChange={(e) => setProfile((p) => ({ ...p, fullName: e.target.value }))}
                    placeholder="Full name"
                    style={{ padding: 10 }}
                  />
                  <input
                    value={profile.titleLine}
                    onChange={(e) => setProfile((p) => ({ ...p, titleLine: e.target.value }))}
                    placeholder="Title line"
                    style={{ padding: 10 }}
                  />
                  <input
                    value={profile.locationLine}
                    onChange={(e) => setProfile((p) => ({ ...p, locationLine: e.target.value }))}
                    placeholder="Location"
                    style={{ padding: 10 }}
                  />
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <input
                      value={profile.email}
                      onChange={(e) => setProfile((p) => ({ ...p, email: e.target.value }))}
                      placeholder="Email"
                      style={{ padding: 10 }}
                    />
                    <input
                      value={profile.phone}
                      onChange={(e) => setProfile((p) => ({ ...p, phone: e.target.value }))}
                      placeholder="Phone"
                      style={{ padding: 10 }}
                    />
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
                    <input
                      value={profile.linkedin}
                      onChange={(e) => setProfile((p) => ({ ...p, linkedin: e.target.value }))}
                      placeholder="LinkedIn"
                      style={{ padding: 10 }}
                    />
                    <input
                      value={profile.portfolio}
                      onChange={(e) => setProfile((p) => ({ ...p, portfolio: e.target.value }))}
                      placeholder="Portfolio"
                      style={{ padding: 10 }}
                    />
                  </div>
                  <textarea
                    value={profile.summary}
                    onChange={(e) => setProfile((p) => ({ ...p, summary: e.target.value }))}
                    placeholder="Summary"
                    rows={4}
                    style={{ padding: 10 }}
                  />
                </div>
              </div>
            </div>

            {/* Selection + batch rewrite */}
            <div style={{ marginTop: 6, border: "1px solid #eee", borderRadius: 12, padding: 12 }}>
              <div style={{ fontWeight: 900, marginBottom: 6 }}>Select → (optional) reassign job → Rewrite</div>

              <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center" }}>
                <button
                  type="button"
                  onClick={() => selectAll(rewritePlan.length)}
                  disabled={!rewritePlan.length}
                  style={{ padding: "8px 12px", fontWeight: 900 }}
                >
                  Select all
                </button>

                <button
                  type="button"
                  onClick={selectNone}
                  disabled={!selectedCount}
                  style={{ padding: "8px 12px", fontWeight: 900 }}
                >
                  Select none
                </button>

                <span style={{ opacity: 0.8 }}>
                  Selected: <strong>{selectedCount}</strong> / {rewritePlan.length}
                </span>

                <button
                  type="button"
                  onClick={handleRewriteSelected}
                  disabled={!selectedCount || loadingBatchRewrite}
                  style={{ padding: "8px 12px", fontWeight: 900 }}
                >
                  {loadingBatchRewrite ? "Rewriting selected…" : "Rewrite selected with AI"}
                </button>
              </div>

              <div style={{ marginTop: 8, opacity: 0.8 }}>
                Jobs + bullet placement are <strong>auto-detected</strong>. You can override per bullet below.
              </div>
            </div>

            {/* Preview */}
            <div style={{ marginTop: 10 }}>
              <div style={{ fontWeight: 900, marginBottom: 8 }}>Live Preview (Template)</div>

              {!resumeHtml ? (
                <div style={{ opacity: 0.75 }}>Run Analyze to generate the preview.</div>
              ) : (
                <div
                  style={{
                    border: "1px solid #e7e7e7",
                    borderRadius: 14,
                    overflow: "hidden",
                    background: "#fff",
                  }}
                >
                  <iframe title="Resume preview" style={{ width: "100%", height: 650, border: "none" }} srcDoc={resumeHtml} />
                </div>
              )}
            </div>
          </section>

          {/* Rewrite Plan list */}
          <div style={{ marginTop: 18 }}>
            <h3 style={{ margin: "10px 0" }}>Rewrite Plan</h3>

            {Array.isArray(rewritePlan) && rewritePlan.length ? (
              <div style={{ display: "grid", gap: 14 }}>
                {rewritePlan.map((item: RewritePlanItem, i: number) => {
                  const original = planItemToText(item);
                  const suggested = keywordsToArray(item?.suggestedKeywords);
                  const rewritten = String(item?.rewrittenBullet ?? "").trim();

                  const notes = Array.isArray(item?.notes) ? item.notes : [];
                  const keywordHits = Array.isArray(item?.keywordHits) ? item.keywordHits : [];
                  const blockedKeywords = Array.isArray(item?.blockedKeywords) ? item.blockedKeywords : [];

                  const beforeVS = item?.verbStrength;
                  const afterVS = rewritten ? computeVerbStrength(rewritten) : undefined;

                  const injectedHits = guardrailTerms.length && rewritten ? findInjectedTerms(rewritten, guardrailTerms) : [];
                  const rewriteBlockedByGuardrail = injectedHits.length > 0;

                  const isSelected = selectedBulletIdx.has(i);

                  const sectionId = assignments[i]?.sectionId || sections[0]?.id || "default";

                  return (
                    <div
                      key={i}
                      style={{
                        border: "1px solid #e5e5e5",
                        borderRadius: 12,
                        padding: 12,
                      }}
                    >
                      <div
                        style={{
                          display: "flex",
                          alignItems: "center",
                          justifyContent: "space-between",
                          gap: 10,
                          marginBottom: 8,
                          flexWrap: "wrap",
                        }}
                      >
                        <label style={{ display: "flex", gap: 8, alignItems: "center" }}>
                          <input type="checkbox" checked={isSelected} onChange={() => toggleSelected(i)} />
                          <span style={{ fontWeight: 900 }}>Bullet {i + 1}</span>
                        </label>

                        <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
                          <span style={{ fontSize: 12, opacity: 0.75 }}>Before:</span>
                          <VerbStrengthBadge vs={beforeVS} />
                          <span style={{ fontSize: 12, opacity: 0.75 }}>After:</span>
                          <VerbStrengthBadge vs={afterVS} />
                          <VerbStrengthDelta before={beforeVS} after={afterVS} />
                        </div>
                      </div>

                      <div style={{ display: "flex", gap: 10, flexWrap: "wrap", alignItems: "center", marginBottom: 10 }}>
                        <div style={{ fontWeight: 800 }}>Job:</div>
                        <select value={sectionId} onChange={(e) => setBulletSection(i, e.target.value)} style={{ padding: "8px 10px" }}>
                          {sections.map((s) => (
                            <option key={s.id} value={s.id}>
                              {s.company} — {s.title}
                            </option>
                          ))}
                        </select>
                        <span style={{ opacity: 0.7, fontSize: 12 }}>
                          Auto-assigned from server jobId mapping (override if needed).
                        </span>
                      </div>

                      {item?.needsMoreInfo ? (
                        <Callout title="Needs more detail" tone="warn">
                          This bullet reads like a label/definition. Add what you did (tested, validated, owned, improved) so the rewrite stays truthful.
                        </Callout>
                      ) : null}

                      <div style={{ marginBottom: 8 }}>
                        <div style={{ fontWeight: 800 }}>Original</div>
                        <div style={{ whiteSpace: "pre-wrap" }}>{original}</div>
                      </div>

                      <div style={{ marginBottom: 8 }}>
                        <div style={{ fontWeight: 800 }}>Suggested keywords</div>
                        <div style={{ opacity: 0.9 }}>{suggested.length ? suggested.join(", ") : "(none)"}</div>
                      </div>

                      {rewriteBlockedByGuardrail ? (
                        <Callout title="Rewrite blocked (guardrail)" tone="danger">
                          The AI output included target-only terms: <strong>{injectedHits.join(", ")}</strong>.
                        </Callout>
                      ) : rewritten ? (
                        <div style={{ marginBottom: 10 }}>
                          <div style={{ fontWeight: 800 }}>Rewritten</div>
                          <div style={{ whiteSpace: "pre-wrap" }}>{rewritten}</div>
                        </div>
                      ) : null}

                      {notes.length ? (
                        <div style={{ marginBottom: 10 }}>
                          <div style={{ fontWeight: 800 }}>Why this rewrite</div>
                          <ul style={{ marginTop: 6 }}>
                            {notes.slice(0, 4).map((n, idx) => (
                              <li key={idx} style={{ marginBottom: 4 }}>
                                {n}
                              </li>
                            ))}
                          </ul>
                        </div>
                      ) : null}

                      {keywordHits.length ? (
                        <div style={{ marginBottom: 10 }}>
                          <div style={{ fontWeight: 800 }}>Keywords used</div>
                          <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 6 }}>
                            {keywordHits.map((k, idx) => (
                              <Chip key={idx} text={String(k)} />
                            ))}
                          </div>
                        </div>
                      ) : null}

                      {blockedKeywords.length ? (
                        <div style={{ marginBottom: 10 }}>
                          <div style={{ fontWeight: 800 }}>Removed keywords</div>
                          <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 6 }}>
                            {blockedKeywords.map((k, idx) => (
                              <Chip key={idx} text={String(k)} muted />
                            ))}
                          </div>
                        </div>
                      ) : null}

                      <button
                        type="button"
                        onClick={() => handleRewriteBullet(i)}
                        disabled={loadingRewriteIndex === i}
                        style={{ padding: "8px 12px", fontWeight: 900 }}
                      >
                        {loadingRewriteIndex === i ? "Rewriting…" : "Rewrite with AI"}
                      </button>
                    </div>
                  );
                })}
              </div>
            ) : (
              <p style={{ opacity: 0.8 }}>No rewrite plan returned yet. Run Analyze.</p>
            )}
          </div>

          {showDebugJson && (
            <div style={{ marginTop: 16 }}>
              <h3 style={{ margin: "10px 0" }}>Debug JSON</h3>
              <pre style={{ overflowX: "auto" }}>{JSON.stringify(analysis, null, 2)}</pre>
            </div>
          )}
        </section>
      )}
    </main>
  );
}
